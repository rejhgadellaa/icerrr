if(!site){var site={};}
site.webapi={};site.webapi.ajaxRequests={};site.vars.downloadsInProgress={};site.webapi.download=function(url,targetPath,targetFile,cb,errcb,progressCb){loggr.log("site.webapi.download()");loggr.log(" > "+url);if(!site.helpers.isConnected()){errcb({code:-1,message:"No connection available"});}
if(targetPath.indexOf("file://")>=0){targetPath=targetPath.substr(targetPath.indexOf("file://"));var res={fullPath:targetPath+"/"+targetFile,name:targetFile};cb(res);}
targetPath=encodeURI(targetPath);targetFile=targetFile;site.storage.getFolderEntry(targetPath,function(folderEntry){if(site.vars.downloadsInProgress[url]==targetFile){loggr.error(" -> Already downloading: "+url+" to "+targetFile);return;}
site.vars.downloadsInProgress[url]=targetFile;loggr.log(" > Init download...");var fileTransfer=new FileTransfer();var dest=encodeURI(folderEntry.fullPath+"/"+targetFile)
var uri=url;var url_decoded=decodeURI(url);if(url==url_decoded){loggr.log(" -> Url needs encoding..");uri=encodeURI(url);}
loggr.log(" >> "+uri);if(progressCb){fileTransfer.onprogress=function(progressEvent){progressCb(progressEvent);}}
fileTransfer.download(uri,dest,function(entry){site.vars.downloadsInProgress[url]=false;cb(entry);},function(error){loggr.error("download error source "+error.source,{dontupload:true});loggr.error("download error target "+error.target,{dontupload:true});loggr.error("download error code "+error.code,{dontupload:true});loggr.error(" > "+site.storage.getFileTransferErrorType(error));site.vars.downloadsInProgress[url]=false;if(errcb){errcb(error);}},true);},function(error){loggr.error("Error: getFolderEntry?");loggr.error(" > "+site.storage.getErrorType(error));console.error(error);errcb(error);});}
site.webapi.getajax=function(url,dataType,cb,errcb){loggr.debug("site.webapi.getajax()");loggr.log(" > "+url);if(!dataType){dataType="text/plain";}
var ajaxReqIdentifier=site.helpers.getUniqueID();var ajaxReq=$.ajax({url:url,dataType:dataType,success:function(data,textStatus,jqXHR){loggr.log(" > site.webapi.getajax().results: "+textStatus);cb(data,textStatus,jqXHR);}}).error(function(jqXHR,textStatus,errorThrown){loggr.error(" > site.webapi.getajax().Error: "+textStatus+", "+errorThrown);errcb({jqXHR:jqXHR,textStatus:textStatus,errorThrown:errorThrown,code:-1,message:errorThrown,extra_fields:["jqXHR","textStatus","errorThrown"]});site.webapi.cleanupAjaxRequests(ajaxReqIdentifier);});site.webapi.ajaxRequests[ajaxReqIdentifier]=ajaxReq;return ajaxReqIdentifier;}
site.webapi.exec=function(apiaction,apiquerystr,cb,errcb){loggr.log("site.webapi.exec()");if(apiaction=="post"){site.webapi.post(apiaction,apiquerystr,cb,errcb);return;}
if(!apiquerystr){apiquerystr="{}";}
var apiqueryobj=JSON.parse(apiquerystr);var apiquery=encodeURIComponent(JSON.stringify(apiqueryobj));var apiurl=site.cfg.urls.api+"a="+apiaction+"&q="+apiquery+"&cache="+(new Date().getTime());loggr.log(" > "+apiurl);loggr.log(" > "+apiquerystr);var ajaxReqIdentifier=site.helpers.getUniqueID();var ajaxReq=$.getJSON(apiurl,function(results){if(results["error"]){errcb({code:-1,message:results["errormsg"]});site.webapi.cleanupAjaxRequests(ajaxReqIdentifier);return;}else{results.info.size_kb=Math.ceil((JSON.stringify(results).length*8)/1024/10);loggr.log(" > site.webapi.exec().results: ~"+results.info.size_kb+" kb");cb(results);site.webapi.cleanupAjaxRequests(ajaxReqIdentifier);return;}}).error(function(jqXHR,textStatus,errorThrown){if(textStatus!="abort"){loggr.error(" > site.webapi.exec().Error: \nApi action: "+apiaction+", "+apiquerystr+"\n"+textStatus+", "+errorThrown);errcb({jqXHR:jqXHR,textStatus:textStatus,errorThrown:errorThrown,code:-1,message:errorThrown,extra_fields:["jqXHR","textStatus","errorThrown"]});}
site.webapi.cleanupAjaxRequests(ajaxReqIdentifier);});site.webapi.ajaxRequests[ajaxReqIdentifier]=ajaxReq;return ajaxReqIdentifier;}
site.webapi.post=function(apiaction,apiquerystr,data,cb,errcb){loggr.log("site.webapi.post()");if(!apiquerystr){apiquerystr="{}";}
var apikey="REJH_ICERRR_APIKEY-"+site.helpers.getUniqueID();var apiqueryobj=JSON.parse(apiquerystr);var apiquery=encodeURIComponent(JSON.stringify(apiqueryobj));var apiurl=site.cfg.urls.api+"a="+apiaction+"&q="+apiquery+"&apikey="+apikey+"&cache="+(new Date().getTime());loggr.log(" > "+apiurl);loggr.log(" > "+apiquerystr);var ajaxReqIdentifier=site.helpers.getUniqueID();var ajaxReq=$.post(apiurl,data,function(results){if(results["error"]){errcb({code:-1,message:results["errormsg"]});site.webapi.cleanupAjaxRequests(ajaxReqIdentifier);return;}else{results.info.size_kb=Math.ceil((JSON.stringify(results).length*8)/1024/10);loggr.log(" > site.webapi.post().results: ~"+results.info.size_kb+" kb");cb(results);site.webapi.cleanupAjaxRequests(ajaxReqIdentifier);return;}}).error(function(jqXHR,textStatus,errorThrown){loggr.error(" > site.webapi.post().Error: \nApi action: "+apiaction+", "+apiquerystr+"\n"+textStatus+", "+errorThrown,{dontupload:true});errcb({jqXHR:jqXHR,textStatus:textStatus,errorThrown:errorThrown,code:-1,message:errorThrown,extra_fields:["jqXHR","textStatus","errorThrown"]});site.webapi.cleanupAjaxRequests(ajaxReqIdentifier);});site.webapi.ajaxRequests[ajaxReqIdentifier]=ajaxReq;return ajaxReqIdentifier;}
site.webapi.abort=function(ajaxReqIdentifier){loggr.debug("site.webapi.abort(): "+ajaxReqIdentifier);loggr.log(" > Abort..");var ajaxReq=site.webapi.ajaxRequests[ajaxReqIdentifier];if(!ajaxReq){loggr.warn(" > Ajax request does not exist (anymore)",{dontsave:true});return;}
ajaxReq.abort();loggr.log(" > Cleanup..");site.webapi.cleanupAjaxRequests(ajaxReqIdentifier);}
site.webapi.cleanupAjaxRequests=function(ajaxReqIdentifier){loggr.debug("site.webapi.cleanupAjaxRequests(): "+ajaxReqIdentifier);var ajaxReq=site.webapi.ajaxRequests[ajaxReqIdentifier];if(!ajaxReq){loggr.warn(" > Ajax request does not exist (anymore)");return;}
var newAjaxRequests={};for(var id in site.webapi.ajaxRequests){if(id==ajaxReqIdentifier){continue;}
if(!site.webapi.ajaxRequests[id]){continue;}
newAjaxRequests[id]=site.webapi.ajaxRequests[id];}
site.webapi.ajaxRequests=newAjaxRequests;}